---
title: Choose a design from those arising from the search
author: Jake Bowers
date: '`r format(Sys.Date(), "%B %d, %Y")`'
fontsize: 11pt
geometry: margin=1in
graphics: yes
indent: false
bibliography:
 - ../refs.bib
biblio-style: authoryear-comp
output:
  pdf_document:
    toc: true
    number_sections: true
    fig_caption: yes
    fig_height: 4
    fig_width: 4
    latex_engine: xelatex
    keep_tex: true
    citation_package: biblatex
    md_extensions: +raw_attribute
---


```{r echo=FALSE, include=FALSE, cache=FALSE}
library(here)
source(here("Analysis","rmarkdownsetup.R"))
library(optmatch)
library(RItools)
library(tidyverse)
```

```{r}
load(here::here("Analysis","match_data_prep.rda"),verbose=TRUE)
load(here::here("Analysis","initial_balance.rda"),verbose=TRUE)
```

First, drop the observations for the placebo pharmacies

```{r}
table(wdat17i$soldvsnot17,exclude=c())
table(wdat17p$soldvsnot17,exclude=c())

dat17i <- wdat17i %>% filter(!is.na(soldvsnot17))
table(dat17i$soldvsnot17,exclude=c())

dat17p <- wdat17p %>% filter(!is.na(soldvsnot17))
table(dat17p$soldvsnot17,exclude=c())
```


## Load results of the search for a good matched design

```{r}
load(here::here("Analysis", "design_soldvsnot_search_res2.rda"),verbose=TRUE)
source(here("Analysis","utilityfns.R"))
```

Basically, all designs look good for balance at the neighborhood level.
`crime_p.value` is from a cluster adjusted assessment of the three crime
variables and treatment. For now, `d2p_i` and `vrobbp` and `robbp` are all
without cluster adjustment --- so, bigger is better but we shouldn't interpret
them strictly speaking. `maxTp` and `d2p` are omnibus balance tests at level of
the neighborhood --- so their values are p-values in the ordinary sense.

```{r}
## Only keep valid results (fix this in utilityfns later.
res_lens <- sapply(results,length)
table(res_lens)
results[res_lens==18][1:2]
results1 <- results[res_lens==20]
## Some text is being converted to NA. This is fine. They were error messages
results2 <- lapply(results1,function(x){ res<-as.numeric(x); names(res) <-
    names(x); return(res)})
results_num <- bind_rows(results2)

resdf0 <- data.frame(results_num)
## Drop any row with NAs
resdf <- na.omit(resdf0)
apply(resdf, 2, summary)
quantile(resdf$maxTp,seq(0,1,.1))
quantile(resdf$d2p,seq(0,1,.1))
apply(resdf,2,quantile,seq(0,1,.1))
```

```{r}
resdf <- resdf %>% rowwise() %>%
    mutate(design_score=design_score(maxTp,vrobbdiff,robbdiff,crime_p=crime_p.value,maxrobbdiff=maxadiff,maxvrobbdiff = maxbdiff,n_trt,effn)) %>% ungroup()
summary(resdf$design_score)

resdf %>% filter(resdf$design_score!=999999) %>%
    dplyr::select(maxTp,vrobbdiff,robbdiff,crime_p.value,maxadiff, maxbdiff,n_trt,effn,effn_i,design_score) %>%
    arrange(design_score)

resdf %>% filter(design_score==min(design_score))

## Focus on solutions in the best 10%
candidates <- resdf %>% filter(resdf$design_score!=999999)  %>% filter(design_score<quantile(design_score,.1))

```


```{r}
pdf(file="designps.pdf")
gp3 <-  ggplot(data=candidates,aes(x=maxTp,y=effn,color=design_score)) +
	geom_point()
print(gp3)
dev.off()

gp4 <- ggplot(data=candidates,aes(x=abs(robbdiff),y=maxadiff,color=design_score)) +
	geom_point()
print(gp4)

```

A couple of possible solutions: (1) The solution that minimizes the design score
(which is a combination of omnibus balance test, crime balance test,
pair-adjusted mean differences in the two crime variables, maximum differences
within pairs on the crime variables, effective sample size (in regards
pharmacies); (2) a solution that chooses the design with largest sample size
among those in the best 10% of the design scores.  Note: `maxadiff` is maximum
difference in `robb` within set, `maxbdiff`, is maximum difference in `vrobb`
within set. And the `vrobbdiff` and `robbdiff` are the set-adjusted mean
differences).


```{r}

parms1 <- candidates %>% filter(design_score==min(design_score))
parms1

parms2 <- candidates %>% filter(effn==max(effn)) %>% filter(x3==max(x3))
parms2

```

Now generate the actual matches and save them for analysis.
Inspect parms1 solution (change this after next run since we will only have x1
to x4 then)

```{r parms1_inspection}
parms1_res <- find_design2(
    x = unlist(dplyr::select(parms1,x2,x3,x4,x5)),
  thebalfmla_b = matchfmla,
  thebalfmla_i = matchfmla_i,
  matchdist = NULL,
  themhdist = mhdist,
  thepsdist = psdist2,
  thepsdisti = psdist_i,
  dista = robbdist,
  distb = vrobbdist,
  datb = dat17p,
  dati = dat17i,
  return_full_objs=TRUE
)

names(parms1_res)
##print(parms1_res$fm_p,grouped=TRUE)
summary(parms1_res$fm_p,max.controls=Inf)
summary(parms1_res$fm_i,max.controls=Inf)
print(parms1_res$maxTp)
print(parms1_res$crime_lm)
print(parms1_res$crime_p)
```

We dropped 24 control neighborhoods at the first stage and 20 people living in
control neighborhoods at the second stage.

```{r}
## Just check that our fm_i stratification is nested within fm_p so that we can
## use it to compare people living in treatment versus control neighborhoods.

## Also add the stratifications to the main datasets
dat17p[names(parms1_res$fm_p),"parms1_fm_p"] <- factor(parms1_res$fm_p)
dat17i[names(parms1_res$fm_i),"parms1_fm_i"] <- factor(parms1_res$fm_i)
dat17i <- inner_join(dat17i,dat17p[,c("Q56","parms1_fm_p")],by="Q56")

## This is what is looks like
dat17i %>% filter(parms1_fm_p=="1.1") %>% select(id,Q56,soldvsnot17,parms1_fm_p,parms1_fm_i) %>% arrange(parms1_fm_i,desc(soldvsnot17),Q56)
dat17i %>% filter(parms1_fm_p=="1.6") %>% select(id,Q56,soldvsnot17,parms1_fm_p,parms1_fm_i) %>% arrange(parms1_fm_i,desc(soldvsnot17),Q56)
dat17i %>% filter(parms1_fm_i=="12.1.5") %>% select(id,Q56,soldvsnot17,parms1_fm_p,parms1_fm_i) %>% arrange(parms1_fm_i,desc(soldvsnot17),Q56)

test1 <- dat17i %>% filter(!is.na(parms1_fm_i)) %>% group_by(parms1_fm_i) %>% summarize(num_fm_p=length(unique(parms1_fm_p)))
stopifnot(all(test1$num_fm_p==1))
```

Parms2 inspection

```{r parms2_inspection}
parms2_res <- find_design2(
  x = unlist(select(parms2,x2,x3,x4,x5)),
  thebalfmla_b = matchfmla,
  thebalfmla_i = matchfmla_i,
  matchdist = NULL,
  themhdist = mhdist,
  thepsdist = psdist2,
  thepsdisti = psdist_i,
  dista = robbdist,
  distb = vrobbdist,
  datb = dat17p,
  dati = dat17i,
  return_full_objs=TRUE
)
names(parms2_res)
print(parms2_res$fm_p,grouped=TRUE)
summary(parms2_res$fm_p,max.controls=Inf)
summary(parms2_res$fm_i,max.controls=Inf)
print(parms2_res$maxTp)
print(parms2_res$crime_lm)
print(parms2_res$crime_p)
```
Looking at these, I prefer parms1, I don't think we gain that much by having
more control pharmacies (18 for parms1 vs 30 for parms2)

```{r}
the_designs <- rbind(parms1=parms1,
parms2=parms2)
the_designs %>%
    dplyr::select(maxTp,vrobbdiff,robbdiff,crime_p.value,maxadiff,maxbdiff,n,n_trt,n_ctrl,effn,effn_i,design_score)

summary(parms1_res$fm_p,max.controls=Inf)
summary(parms1_res$fm_i,max.controls=Inf)

summary(parms2_res$fm_p,max.controls=Inf)
summary(parms2_res$fm_i,max.controls=Inf)


```

Save chosen design info:

```{r}
save(parms1_res,parms2_res,file=here("Analysis","design_soldvsnot.rda"))
```






