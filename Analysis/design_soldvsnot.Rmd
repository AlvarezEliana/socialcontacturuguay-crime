---
title: Choose a design from those arising from the search
author: Jake Bowers
date: '`r format(Sys.Date(), "%B %d, %Y")`'
fontsize: 11pt
geometry: margin=1in
graphics: yes
indent: false
bibliography:
 - ../refs.bib
biblio-style: authoryear-comp
output:
  pdf_document:
    toc: true
    number_sections: true
    fig_caption: yes
    fig_height: 4
    fig_width: 4
    latex_engine: xelatex
    keep_tex: true
    citation_package: biblatex
    md_extensions: +raw_attribute
---


```{r echo=FALSE, include=FALSE, cache=FALSE}
library(here)
source(here("Analysis","rmarkdownsetup.R"))
library(optmatch)
library(RItools)
library(tidyverse)
```

```{r}
load(here::here("Analysis","match_data_prep.rda"),verbose=TRUE)
load(here::here("Analysis","initial_balance.rda"),verbose=TRUE)
```

## Load results of the search for a good matched design

```{r}
load(here::here("Analysis","opt_res.rda"),verbose=TRUE)
load(here::here("Analysis", "design_soldvsnot_search_res2.rda"),verbose=TRUE)
source(here("Analysis","utilityfns.R"))
```

We searched for a design that compared neighborhoods to each other that
satisfied several criteria: (1) across a large number of covariates,
covariate-to-treatment relation ship had to compare favorably to those typical
of a randomized experiment (calculated at both the pharmacy level and the level
of individual survey respondents, adjusted for clustering at the
pharmacy/neighborhood level) (`score_maxTp` and `score_d2_p_i_p`; (2)
administrative data on violent robberies, robberies, and survey data on
perceptions of crime should not strongly related to whether or not a pharmacy
sold marijuana conditional on strata `score_crime_p`; (3) mean robberies and
violent robberies should be very similar between treated and control pharmacies
conditional on strata, `score_vrobbdiff` and `score_robbdiff`; (4) the largest
differences in robberies and violent robberies between treated and control
neighborhoods within set should be a small as possible (it cannot be zero, but
we can make this maximum difference small), `score_maxvrobbdiff` and
`score_maxrobbdiff`; and (5) the effective sample size should be as large as
possible (`effn`). We required that we use all 16 of the selling pharmacies as
the treated pharmacies, but we preferred to keep as many of the non-selling
pharmacies as possible (thus the effective sample size).

The code below shows this score:

```{r}
print(design_score)
```

We searched for a stratification that would maximize this score by varying
calipers on a mahalanobis distance matrix, a propensity score distance matrix,
a matrix of differences in robberies, a matrix of differences in violent
robberies. The search used a genetic algorithm run in multiple passes to ensure
that it was not overly dependent on starting values. Code in
`designsearch_soldvsnot.R`.

We show the raw scores for the found best design below.

Note: `maxadiff` is maximum difference in `robb` within set, `maxbdiff`, is
maximum difference in `vrobb` within set. And the `vrobbdiff` and `robbdiff` are
the set-adjusted mean differences).

So, below we see that the chosen design compares favorably with a randomized
experiment (`d2p_i` and `maxTp`), has little difference in crime between treated
and control neighborhoods within pair on average (`vrobbdiff`, `robbdiff`), and
in the worse set (`maxadiff` and `maxbdiff`), nor can we predict treatment
status from crime variables conditional on strata (`crime_p.value`). We use all
treated pharmacies `n_trt` and 18 control pharmarcies `n_ctrl`.

```{r}
parms1_lst <- sapply(1:nrow(opt_res@solution),function(i){
    x <- opt_res@solution[i,]
find_design2(
    x = x,
  thebalfmla_b = matchfmla,
  thebalfmla_i = matchfmla_i,
  themhdist = mhdist,
  thepsdist = psdist2,
  dista = robbdist,
  distb = vrobbdist,
  datb = dat17p,
  dati = dat17i,
  return_full_objs=FALSE
)
})
parms1_lst ## all identical so just use first one

parms1 <- find_design2(
    x = opt_res@solution[1,],
  thebalfmla_b = matchfmla,
  thebalfmla_i = matchfmla_i,
  themhdist = mhdist,
  thepsdist = psdist2,
  dista = robbdist,
  distb = vrobbdist,
  datb = dat17p,
  dati = dat17i,
  return_full_objs=FALSE
)

parms1
```

Now generate the actual matches and save them for analysis.

Inspect parms1 solution

```{r parms1_inspection}
parms1_res <- find_design2(
    x = parms1[1:4],
  thebalfmla_b = matchfmla,
  thebalfmla_i = matchfmla_i,
  themhdist = mhdist,
  thepsdist = psdist2,
  dista = robbdist,
  distb = vrobbdist,
  datb = dat17p,
  dati = dat17i,
  return_full_objs=TRUE
)

names(parms1_res)
##print(parms1_res$fm_p,grouped=TRUE)
summary(parms1_res$fm_p,max.controls=Inf)
print(parms1_res$maxTp)
print(parms1_res$xb_i$overall[,])
print(parms1_res$crime_lm)
print(parms1_res$crime_p)
```
Save chosen design info:

```{r}
save(parms1_res,parms1, dat17i,dat17p,file=here("Analysis","design_soldvsnot.rda"))
```






