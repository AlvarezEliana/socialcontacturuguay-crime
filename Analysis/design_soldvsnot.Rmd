---
title: Compare pharmacies who sold starting at the beginning (16) to those never selling (42).
author: Jake Bowers
date: '`r format(Sys.Date(), "%B %d, %Y")`'
fontsize: 11pt
geometry: margin=1in
graphics: yes
indent: false
bibliography:
 - ../refs.bib
biblio-style: authoryear-comp
output:
  pdf_document:
    toc: true
    number_sections: true
    fig_caption: yes
    fig_height: 4
    fig_width: 4
    latex_engine: xelatex
    keep_tex: true
    citation_package: biblatex
    md_extensions: +raw_attribute
---


```{r echo=FALSE, include=FALSE, cache=FALSE}
library(here)
source(here("Analysis","rmarkdownsetup.R"))
library(optmatch)
library(RItools)
library(tidyverse)
```

```{r}
load(here::here("Analysis","match_data_prep.rda"),verbose=TRUE)
load(here::here("Analysis","initial_balance.rda"),verbose=TRUE)
```

First, drop the observations for the placebo pharmacies

```{r}
table(wdat17i$soldvsnot17,exclude=c())
table(wdat17p$soldvsnot17,exclude=c())

dat17i <- wdat17i %>% filter(!is.na(soldvsnot17))
table(dat17i$soldvsnot17,exclude=c())

dat17p <- wdat17p %>% filter(!is.na(soldvsnot17))
table(dat17p$soldvsnot17,exclude=c())
```


## Load results of the search for a good matched design

```{r}
load(here::here("Analysis", "design_soldvsnot_search_res2.rda"),verbose=TRUE)
```

Basically, all designs look good for balance at the neighborhood level.
`crime_p.value` is from a cluster adjusted assessment of the three crime
variables and treatment. For now, `d2p_i` and `vrobbp` and `robbp` are all
without cluster adjustment --- so, bigger is better but we shouldn't interpret
them strictly speaking. `maxTp` and `d2p` are omnibus balance tests at level of
the neighborhood --- so their values are p-values in the ordinary sense.

```{r}
## Convert character to numeric (maybe change this if we search again)
results_num <- apply(results,1,as.numeric)
resdf0 <- data.frame(results_num)
## Drop any row with NAs
resdf <- na.omit(resdf0)
apply(resdf, 2, summary)
quantile(resdf$maxTp,seq(0,1,.1))
quantile(resdf$d2p,seq(0,1,.1))
apply(resdf,2,quantile,seq(0,1,.1))
```



```{r}
pdf(file="designps.pdf")
gp3 <-  ggplot(data=resdf,aes(x=maxTp,y=effn,color=crime_p.value)) +
	geom_point()
print(gp3)
dev.off()

gp4 <-  ggplot(data=resdf,aes(x=abs(robbdiff),y=maxadiff,color=crime_p.value)) +
	geom_point()
print(gp4)


gp5 <-  ggplot(data=resdf,aes(x=abs(vrobbdiff),y=maxbdiff,color=crime_p.value)) +
	geom_point()
print(gp5)


gp5 <-  resdf %>% filter(maxTp >= .05 & effn >= 15 & maxadiff < 50 & maxbdiff < 30)  %>% ggplot(aes(x=crime_p.value,y=maxadiff,color=effn)) +
	geom_point()
print(gp5)


```


Use three possible solutions:

```{r}

## Choose a design that is pretty balanced overall but also considers sample size and focuses on closeness on crime variables
parms1 <- resdf %>% filter(maxTp >= .4)  %>% filter(crime_p.value > .25) %>% filter(effn==max(effn))
parms1

## Now focus on the worst crime difference and mean crime differences with some
## overall balance
parms2 <- resdf  %>% filter(maxadiff < quantile(maxadiff,.25) & maxbdiff < quantile(maxbdiff,.25)) %>% filter(crime_p.value > .1 & maxTp > .1) %>% 
    filter(abs(robbdiff) < 1) %>% filter(effn==max(effn))
parms2

## What about (nearly) maximizing overall balance?
parms3 <- resdf  %>% filter(maxTp > quantile(maxTp,.9)) %>% filter(effn==max(effn))
parms3

```

The summary of  the three candidates (choosing the one that has the largest/most
permissive calipers)

```{r}
parms1 <- parms1 %>% filter(x3==max(x3))
parms2 <- parms2 %>% filter(x3==max(x3)) %>% filter(maxTp==max(maxTp))
parms3 <- parms3 %>% filter(x3==max(x3))

parms1
parms2
parms3
```

Now generate the actual matches and save them for analysis.

```{r}
source(here("Analysis","utilityfns.R"))
```

```{r}

parms1_res <- find_design2(
  x = unlist(select(parms1,x1,x2,x3,x4,x5)),
  thebalfmla_b = matchfmla,
  thebalfmla_i = matchfmla_i,
  matchdist = NULL,
  themhdist = mhdist,
  thepsdist = psdist2,
  thepsdisti = psdist_i,
  dista = robbdist,
  distb = vrobbdist,
  datb = dat17p,
  dati = dat17i,
  return_full_objs=FALSE
)

print(parms1_res$fm_p,grouped=TRUE)
print(parms1_res$maxTp)

```


