---
title: Choose a design from those arising from the search
author: Jake Bowers
date: '`r format(Sys.Date(), "%B %d, %Y")`'
fontsize: 11pt
geometry: margin=1in
graphics: yes
indent: false
bibliography:
 - ../refs.bib
biblio-style: authoryear-comp
output:
  pdf_document:
    toc: true
    number_sections: true
    fig_caption: yes
    fig_height: 4
    fig_width: 4
    latex_engine: xelatex
    keep_tex: true
    citation_package: biblatex
    md_extensions: +raw_attribute
---


```{r echo=FALSE, include=FALSE, cache=FALSE}
library(here)
source(here("Analysis","rmarkdownsetup.R"))
library(optmatch)
library(RItools)
library(tidyverse)
```

```{r}
load(here::here("Analysis","match_data_prep.rda"),verbose=TRUE)
load(here::here("Analysis","initial_balance.rda"),verbose=TRUE)
```

## Load results of the search for a good matched design

```{r}
load(here::here("Analysis","opt_res.rda"),verbose=TRUE)
load(here::here("Analysis", "design_soldvsnot_search_res2.rda"),verbose=TRUE)
source(here("Analysis","utilityfns.R"))
```

TODO: Clean this up given optimization approach.


`crime_p.value` is from a cluster adjusted assessment of the three crime
variables and treatment. For now, `d2p_i` and `vrobbp` and `robbp` are all
without cluster adjustment --- so, bigger is better but we shouldn't interpret
them strictly speaking. `maxTp` and `d2p` are omnibus balance tests at level of
the neighborhood --- so their values are p-values in the ordinary sense.

```{r}
resdf0 <- data.frame(t(results))
## Drop any row with NAs
resdf <- na.omit(resdf0)
apply(resdf, 2, summary)
quantile(resdf$maxTp,seq(0,1,.1))
quantile(resdf$d2p,seq(0,1,.1))
apply(resdf,2,quantile,seq(0,1,.1))
```

Calculate the design score for each possible design. The design score combines
the overall balance p-value, the balance p-value for just the three crime
variables (including perceptions of crime), average pair-adjusted differences in
robberies and violent robberis, the size of the maximum difference in
robberies/violent robberies within pair, the size of the the treatment group
(i.e. the number of selling pharmacies included in the design, currently
restricted to 16 --- not dropping any of them), and the effective sample size
at the level of the neighborhood/pharmacy (which ranges from about 16 for pairs
to about 19 for cases with some 1 to more than one control pharmacy matches).

```{r}
resdf <- resdf %>% rowwise() %>%
    mutate(design_score=design_score(maxTp=maxTp,d2p_i=d2p_i,vrobbdiff=vrobbdiff,robbdiff=robbdiff,crime_p=crime_p.value,maxrobbdiff=maxadiff,maxvrobbdiff = maxbdiff,n_trt=n_trt,effn=effn)) %>% ungroup()
summary(resdf$design_score)

resdf %>% filter(resdf$design_score!=-999999) %>%
    dplyr::select(maxTp,vrobbdiff,robbdiff,crime_p.value,maxadiff, maxbdiff,n_trt,effn,design_score) %>%
    arrange(desc(design_score))

## The  best design score
resdf %>% filter(design_score==max(design_score))

## Focus on solutions in the best 10%
candidates <- resdf %>% filter(resdf$design_score!=-999999)  %>% filter(design_score>quantile(design_score,.95))
dim(candidates)
summary(candidates)
```


```{r}
pdf(file="designps.pdf")
gp3 <-  ggplot(data=candidates,aes(x=maxTp,y=effn,color=design_score)) +
	geom_point()
print(gp3)
dev.off()

gp4 <- ggplot(data=candidates,aes(x=abs(robbdiff),y=maxadiff,color=design_score)) +
	geom_point()
print(gp4)

```

A few possible solutions: Note: `maxadiff` is maximum
difference in `robb` within set, `maxbdiff`, is maximum difference in `vrobb`
within set. And the `vrobbdiff` and `robbdiff` are the set-adjusted mean
differences).


```{r}


parms1 <- resdf %>% filter(maxadiff <= quantile(maxadiff,.5) & maxbdiff <= quantile(maxbdiff,.5)) %>% filter(maxTp==max(maxTp))
parms1

parms2 <- resdf %>% filter(design_score==max(design_score))
parms2

parms3_lst <- sapply(1:nrow(opt_res@solution),function(i){
    x <- opt_res@solution[i,]
find_design2(
    x = x,
  thebalfmla_b = matchfmla,
  thebalfmla_i = matchfmla_i,
  themhdist = mhdist,
  thepsdist = psdist2,
  dista = robbdist,
  distb = vrobbdist,
  datb = dat17p,
  dati = dat17i,
  return_full_objs=FALSE
)
})
parms3_lst ## all identical so just use first one

parms3 <- find_design2(
    x = opt_res@solution[1,],
  thebalfmla_b = matchfmla,
  thebalfmla_i = matchfmla_i,
  themhdist = mhdist,
  thepsdist = psdist2,
  dista = robbdist,
  distb = vrobbdist,
  datb = dat17p,
  dati = dat17i,
  return_full_objs=FALSE
)

parms3
```

Now generate the actual matches and save them for analysis.
Inspect parms1 solution (change this after next run since we will only have x1
to x4 then)

```{r parms1_inspection}
parms1_res <- find_design2(
    x = unlist(dplyr::select(parms1,x1,x2,x3,x4)),
  thebalfmla_b = matchfmla,
  thebalfmla_i = matchfmla_i,
  themhdist = mhdist,
  thepsdist = psdist2,
  dista = robbdist,
  distb = vrobbdist,
  datb = dat17p,
  dati = dat17i,
  return_full_objs=TRUE
)

names(parms1_res)
##print(parms1_res$fm_p,grouped=TRUE)
summary(parms1_res$fm_p,max.controls=Inf)
print(parms1_res$maxTp)
print(parms1_res$xb_i$overall[,])
print(parms1_res$crime_lm)
print(parms1_res$crime_p)
```


Parms2 inspection

```{r parms2_inspection}
parms2_res <- find_design2(
    x = unlist(dplyr::select(parms2,x1,x2,x3,x4)),
  thebalfmla_b = matchfmla,
  thebalfmla_i = matchfmla_i,
  themhdist = mhdist,
  thepsdist = psdist2,
  dista = robbdist,
  distb = vrobbdist,
  datb = dat17p,
  dati = dat17i,
  return_full_objs=TRUE
)

names(parms2_res)
##print(parms2_res$fm_p,grouped=TRUE)
summary(parms2_res$fm_p,max.controls=Inf)
print(parms2_res$maxTp)
print(parms2_res$xb_i$overall[,])
print(parms2_res$crime_lm)
print(parms2_res$crime_p)
```



Parms3 inspection


```{r parms3_inspection}
parms3_res <- find_design2(
    x = parms3[1:4],
  thebalfmla_b = matchfmla,
  thebalfmla_i = matchfmla_i,
  themhdist = mhdist,
  thepsdist = psdist2,
  dista = robbdist,
  distb = vrobbdist,
  datb = dat17p,
  dati = dat17i,
  return_full_objs=TRUE
)

names(parms3_res)
##print(parms3_res$fm_p,grouped=TRUE)
summary(parms3_res$fm_p,max.controls=Inf)
print(parms3_res$maxTp)
print(parms3_res$xb_i$overall[,])
print(parms3_res$crime_lm)
print(parms3_res$crime_p)
```



```{r}
the_designs <- rbind(parms1=parms1,
    parms2=parms2,parms3=c(parms3,opt_res@fitnessValue))

the_designs %>%
    dplyr::select(maxTp,vrobbdiff,robbdiff,crime_p.value,maxadiff,maxbdiff,n,n_trt,n_ctrl,effn,design_score)

summary(parms1_res$fm_p,max.controls=Inf)
summary(parms1_res$fm_i,max.controls=Inf)

summary(parms2_res$fm_p,max.controls=Inf)
summary(parms2_res$fm_i,max.controls=Inf)

summary(parms3_res$fm_p,max.controls=Inf)
summary(parms3_res$fm_i,max.controls=Inf)

```

Choosing parms1. 
Save chosen design info:

```{r}
save(parms1_res,parms2_res,parms3_res,parms1, parms2, parms3, dat17i,dat17p,file=here("Analysis","design_soldvsnot.rda"))
```






