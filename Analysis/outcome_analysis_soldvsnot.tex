\documentclass[11pt,]{article}
\usepackage{lmodern}
\usepackage{amssymb,amsmath}
\usepackage{ifxetex,ifluatex}
\usepackage{fixltx2e} % provides \textsubscript
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
\else % if luatex or xelatex
  \ifxetex
    \usepackage{mathspec}
  \else
    \usepackage{fontspec}
  \fi
  \defaultfontfeatures{Ligatures=TeX,Scale=MatchLowercase}
\fi
% use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
% use microtype if available
\IfFileExists{microtype.sty}{%
\usepackage{microtype}
\UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\usepackage[margin=1in]{geometry}
\usepackage{hyperref}
\hypersetup{unicode=true,
            pdftitle={Outcome Analysis of the SoldVsNot Design},
            pdfauthor={Jake Bowers},
            pdfborder={0 0 0},
            breaklinks=true}
\urlstyle{same}  % don't use monospace font for urls
\usepackage[style=authoryear-comp]{biblatex}

\addbibresource{../refs.bib}
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{longtable,booktabs}
\usepackage{graphicx,grffile}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
\IfFileExists{parskip.sty}{%
\usepackage{parskip}
}{% else
\setlength{\parindent}{0pt}
\setlength{\parskip}{6pt plus 2pt minus 1pt}
}
\setlength{\emergencystretch}{3em}  % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{5}
% Redefines (sub)paragraphs to behave more like sections
\ifx\paragraph\undefined\else
\let\oldparagraph\paragraph
\renewcommand{\paragraph}[1]{\oldparagraph{#1}\mbox{}}
\fi
\ifx\subparagraph\undefined\else
\let\oldsubparagraph\subparagraph
\renewcommand{\subparagraph}[1]{\oldsubparagraph{#1}\mbox{}}
\fi

%%% Use protect on footnotes to avoid problems with footnotes in titles
\let\rmarkdownfootnote\footnote%
\def\footnote{\protect\rmarkdownfootnote}

%%% Change title format to be more compact
\usepackage{titling}

% Create subtitle command for use in maketitle
\providecommand{\subtitle}[1]{
  \posttitle{
    \begin{center}\large#1\end{center}
    }
}

\setlength{\droptitle}{-2em}

  \title{Outcome Analysis of the SoldVsNot Design}
    \pretitle{\vspace{\droptitle}\centering\huge}
  \posttitle{\par}
    \author{Jake Bowers}
    \preauthor{\centering\large\emph}
  \postauthor{\par}
      \predate{\centering\large\emph}
  \postdate{\par}
    \date{August 26, 2019}


\begin{document}
\maketitle

{
\setcounter{tocdepth}{2}
\tableofcontents
}
\scriptsize\normalsize

\scriptsize

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{load}\NormalTok{(here}\OperatorTok{::}\KeywordTok{here}\NormalTok{(}\StringTok{"Data"}\NormalTok{, }\StringTok{"finaldat.rda"}\NormalTok{), }\DataTypeTok{verbose =} \OtherTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Loading objects:
  finaldat
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{load}\NormalTok{(here}\OperatorTok{::}\KeywordTok{here}\NormalTok{(}\StringTok{"Data"}\NormalTok{, }\StringTok{"wrkdat.rda"}\NormalTok{), }\DataTypeTok{verbose =} \OtherTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Loading objects:
  wrkdat
  allvars2
  allvars
  allcovs
  designvars
  outcomes
  covs
  covsCensus
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{load}\NormalTok{(here}\OperatorTok{::}\KeywordTok{here}\NormalTok{(}\StringTok{"Analysis"}\NormalTok{, }\StringTok{"match_data_prep.rda"}\NormalTok{), }\DataTypeTok{verbose =} \OtherTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Loading objects:
  wdat17p
  wdat17i
  wdat18p
  wdat18i
  covs3
  allcovs
  outcomes
  designvars
  covsCensus
  covs
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{load}\NormalTok{(here}\OperatorTok{::}\KeywordTok{here}\NormalTok{(}\StringTok{"Analysis"}\NormalTok{, }\StringTok{"design_soldvsnot.rda"}\NormalTok{), }\DataTypeTok{verbose =} \OtherTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Loading objects:
  fm1
  fm2
  fm3
  xb1
  xb2
  xb3
  xb1vars
  xb2vars
  xb3vars
  xb_i1
  xb_i2
  xb_i3
  xb_i1vars
  xb_i2vars
  xb_i3vars
  parms1
  parms2
  parms3
  xbi
  xb123
  dat17i
  dat17p
\end{verbatim}

\normalsize

\hypertarget{analyses-registered}{%
\section{Analyses Registered}\label{analyses-registered}}

We registered the following analyses in
\url{https://osf.io/aey7w/registrations}

\hypertarget{data-setup-for-the-analyses}{%
\subsection{Data Setup for the
Analyses}\label{data-setup-for-the-analyses}}

Not all outcome variables are available in endline survey.

\scriptsize

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{regoutcomes <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"n_sec_i"}\NormalTok{, }\StringTok{"c_sec_i"}\NormalTok{, }\StringTok{"vic12_i"}\NormalTok{, }\StringTok{"dt_impact_i"}\NormalTok{, }\StringTok{"ps_impact_i"}\NormalTok{, }\StringTok{"boca1_i"}\NormalTok{, }\StringTok{"social_dis"}\NormalTok{, }\StringTok{"activities_index"}\NormalTok{)}
\NormalTok{regcovs <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"ideol_si_i"}\NormalTok{, }\StringTok{"educ_i"}\NormalTok{, }\StringTok{"sex_i"}\NormalTok{, }\StringTok{"age_i"}\NormalTok{)}
\NormalTok{regdesignvars <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"id"}\NormalTok{, }\StringTok{"Q56"}\NormalTok{, }\StringTok{"treat"}\NormalTok{, }\StringTok{"ronda"}\NormalTok{, }\StringTok{"ph_type"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\normalsize

We want the versions of the variable without imputation for missing
values

\scriptsize

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{outdat2 <-}\StringTok{ }\NormalTok{finaldat }\OperatorTok{%>%}
\StringTok{  }\NormalTok{dplyr}\OperatorTok{::}\KeywordTok{select}\NormalTok{(}\KeywordTok{c}\NormalTok{(regdesignvars, regoutcomes, regcovs)) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{filter}\NormalTok{(ronda }\OperatorTok{==}\StringTok{ }\DecValTok{2018}\NormalTok{)}

\NormalTok{outdat2 <-}\StringTok{ }\NormalTok{outdat2 }\OperatorTok{%>%}\StringTok{ }\KeywordTok{mutate_if}\NormalTok{(is.character, as.numeric)}

\NormalTok{replace_NA_}\DecValTok{0}\NormalTok{ <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(x) \{}
  \KeywordTok{ifelse}\NormalTok{(x }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{88}\NormalTok{, }\DecValTok{99}\NormalTok{), }\OtherTok{NA}\NormalTok{, x)}
\NormalTok{\}}

\CommentTok{## Make all 88 and 99 responses into NA}
\NormalTok{outdat3 <-}\StringTok{ }\NormalTok{outdat2 }\OperatorTok{%>%}
\StringTok{  }\NormalTok{dplyr}\OperatorTok{::}\KeywordTok{select}\NormalTok{(}\OperatorTok{-}\KeywordTok{c}\NormalTok{(}\StringTok{"id"}\NormalTok{, }\StringTok{"age_i"}\NormalTok{)) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{mutate_all}\NormalTok{(replace_NA_}\DecValTok{0}\NormalTok{)}
\KeywordTok{stopifnot}\NormalTok{(}\KeywordTok{sum}\NormalTok{(}\KeywordTok{is.na}\NormalTok{(outdat3}\OperatorTok{$}\NormalTok{boca1_i)) }\OperatorTok{==}\StringTok{ }\DecValTok{288}\NormalTok{) }\CommentTok{## make sure to preserve missings}
\NormalTok{outdat3}\OperatorTok{$}\NormalTok{id <-}\StringTok{ }\NormalTok{outdat2}\OperatorTok{$}\NormalTok{id}
\NormalTok{outdat3}\OperatorTok{$}\NormalTok{age_i <-}\StringTok{ }\NormalTok{outdat2}\OperatorTok{$}\NormalTok{age_i}
\CommentTok{## How much missing data is there?}
\NormalTok{outdat3 }\OperatorTok{%>%}\StringTok{ }\KeywordTok{summarise_all}\NormalTok{(}\OperatorTok{~}\StringTok{ }\KeywordTok{sum}\NormalTok{(}\KeywordTok{is.na}\NormalTok{(.)))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
  Q56 treat ronda ph_type n_sec_i c_sec_i vic12_i dt_impact_i ps_impact_i boca1_i social_dis activities_index ideol_si_i educ_i
1   0     0     0       0       1       2       0          32          21     288          0                4         41      1
  sex_i id age_i
1     0  0     0
\end{verbatim}

\normalsize

Now merge the pharmacy level design onto the individual level data

\scriptsize

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{designdat <-}\StringTok{ }\NormalTok{dat17p }\OperatorTok{%>%}\StringTok{ }\NormalTok{dplyr}\OperatorTok{::}\KeywordTok{select}\NormalTok{(}\KeywordTok{c}\NormalTok{(}\StringTok{"Q56"}\NormalTok{, }\StringTok{"fm2"}\NormalTok{, }\StringTok{"soldvsnot17"}\NormalTok{, }\StringTok{"ph_type"}\NormalTok{, }\StringTok{"pscore1"}\NormalTok{, }\StringTok{"pscore2"}\NormalTok{))}

\CommentTok{## Two pharmacies (the placebos) were dropped}
\KeywordTok{stopifnot}\NormalTok{(}\KeywordTok{length}\NormalTok{(}\KeywordTok{unique}\NormalTok{(designdat}\OperatorTok{$}\NormalTok{Q56)) }\OperatorTok{==}\StringTok{ }\DecValTok{58}\NormalTok{)}
\KeywordTok{stopifnot}\NormalTok{(}\KeywordTok{unique}\NormalTok{(designdat}\OperatorTok{$}\NormalTok{ph_type) }\OperatorTok{!=}\StringTok{ }\DecValTok{5}\NormalTok{)}

\NormalTok{outdat4 <-}\StringTok{ }\KeywordTok{inner_join}\NormalTok{(outdat3, designdat)}
\KeywordTok{stopifnot}\NormalTok{(}\KeywordTok{isTRUE}\NormalTok{(}\KeywordTok{all.equal}\NormalTok{(}\KeywordTok{sort}\NormalTok{(}\KeywordTok{unique}\NormalTok{(designdat}\OperatorTok{$}\NormalTok{Q56)), }\KeywordTok{sort}\NormalTok{(}\KeywordTok{unique}\NormalTok{(outdat4}\OperatorTok{$}\NormalTok{Q56)))))}

\NormalTok{outdat4 }\OperatorTok{%>%}\StringTok{ }\KeywordTok{summarise_all}\NormalTok{(}\OperatorTok{~}\StringTok{ }\KeywordTok{sum}\NormalTok{(}\KeywordTok{is.na}\NormalTok{(.)))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
  Q56 treat ronda ph_type n_sec_i c_sec_i vic12_i dt_impact_i ps_impact_i boca1_i social_dis activities_index ideol_si_i educ_i
1   0     0     0       0       0       1       0          30          19     256          0                3         38      1
  sex_i id age_i fm2 soldvsnot17 pscore1 pscore2
1     0  0     0 112           0       0       0
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{dim}\NormalTok{(outdat4)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 638  21
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{## Remove non-selling pharmacies dropped during the design-search process}
\NormalTok{outdat5 <-}\StringTok{ }\NormalTok{outdat4 }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{filter}\NormalTok{(}\OperatorTok{!}\KeywordTok{is.na}\NormalTok{(fm2)) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{ungroup}\NormalTok{()}
\KeywordTok{dim}\NormalTok{(outdat5)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 526  21
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{## ## block center the covariates}
\CommentTok{## block_center <- function(x)\{}
\CommentTok{##  x - mean(x)}
\CommentTok{## \}}
\CommentTok{## covdat <- optmatch::fill.NAs(outdat5[,c("fm2",regcovs)])}
\CommentTok{## covdat <- covdat %>% group_by(fm2) %>% mutate_all(block_center)}
\CommentTok{## outdat6 <- outdat5 %>% dplyr::select(-regcovs)}
\CommentTok{## outdat7 <- bind_cols(outdat6,covdat)}
\CommentTok{## regcovs2 <- names(covdat)}
\end{Highlighting}
\end{Shaded}

\normalsize

A quick check

\scriptsize

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{## Do we need  to worry about means (maybe)}
\NormalTok{outdat5 }\OperatorTok{%>%}
\StringTok{  }\NormalTok{dplyr}\OperatorTok{::}\KeywordTok{select}\NormalTok{(regoutcomes) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{summarize_all}\NormalTok{(}\OperatorTok{~}\StringTok{ }\KeywordTok{length}\NormalTok{(}\KeywordTok{unique}\NormalTok{(.)))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
  n_sec_i c_sec_i vic12_i dt_impact_i ps_impact_i boca1_i social_dis activities_index
1       4       5       2           5           5       3          9               22
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{outdat5 }\OperatorTok{%>%}
\StringTok{  }\NormalTok{dplyr}\OperatorTok{::}\KeywordTok{select}\NormalTok{(regcovs) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{summarize_all}\NormalTok{(}\OperatorTok{~}\StringTok{ }\KeywordTok{length}\NormalTok{(}\KeywordTok{unique}\NormalTok{(.)))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
  ideol_si_i educ_i sex_i age_i
1         11     10     2    71
\end{verbatim}

\normalsize

\hypertarget{testing-hypotheses-of-no-effects}{%
\subsection{Testing hypotheses of no
effects}\label{testing-hypotheses-of-no-effects}}

Comparing a few approaches here (as preregistered) because of concerns
about the small number of clusters. Later we will mount a small
simulation to assess the false positive rate of the tests done here.

Doing the tests without covariance adjustment first.

\hypertarget{tests-of-of-the-weak-null-combined-with-estimates-of-the-ate}{%
\subsubsection{Tests of of the weak null combined with estimates of the
ATE}\label{tests-of-of-the-weak-null-combined-with-estimates-of-the-ate}}

First, we do the simple thing --- estimate the ATE and test the weak
null of no effects under asymptotic assumptions. If we define the ATE
conditional on the non-missing outcomes (necessary if we are going to
use simulations to assess operating characteristics of our estimators
and tests), then we neeed to recalculate the block-size weights for each
outcome.

\scriptsize

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{center_covs <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(dat, covnms, blocks) \{}
\NormalTok{  block_center <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(x) \{}
\NormalTok{    x }\OperatorTok{-}\StringTok{ }\KeywordTok{mean}\NormalTok{(x)}
\NormalTok{  \}}
\NormalTok{  covdat <-}\StringTok{ }\NormalTok{optmatch}\OperatorTok{::}\KeywordTok{fill.NAs}\NormalTok{(dat[, }\KeywordTok{c}\NormalTok{(blocks, covnms)])}
\NormalTok{  covdat <-}\StringTok{ }\NormalTok{covdat }\OperatorTok{%>%}
\StringTok{    }\KeywordTok{group_by}\NormalTok{(}\OperatorTok{!!}\NormalTok{rlang}\OperatorTok{::}\KeywordTok{sym}\NormalTok{(blocks)) }\OperatorTok{%>%}
\StringTok{    }\KeywordTok{mutate_at}\NormalTok{(}\KeywordTok{vars}\NormalTok{(}\OperatorTok{-}\KeywordTok{group_cols}\NormalTok{()), block_center)}
  \KeywordTok{return}\NormalTok{(covdat)}
\NormalTok{\}}

\CommentTok{## Next works thanks to https://thisisnic.github.io/2018/03/27/using-tidy-eval-with-dplyr-filter/}
\NormalTok{est1fn <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(ynm, }\DataTypeTok{covnms =} \OtherTok{NULL}\NormalTok{, dat, blocks, clusters, }\DataTypeTok{weights =} \OtherTok{NULL}\NormalTok{, ...) \{}
  \CommentTok{## for now weights must be nbwt or hbwt}
  \KeywordTok{stopifnot}\NormalTok{(}\KeywordTok{is.null}\NormalTok{(weights) }\OperatorTok{|}\StringTok{ }\NormalTok{weights }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"nbwt"}\NormalTok{, }\StringTok{"hbwt"}\NormalTok{))}
\NormalTok{  dat <-}\StringTok{ }\NormalTok{dat }\OperatorTok{%>%}
\StringTok{    }\KeywordTok{filter}\NormalTok{(}\OperatorTok{!}\KeywordTok{is.na}\NormalTok{(}\OperatorTok{!!}\NormalTok{rlang}\OperatorTok{::}\KeywordTok{sym}\NormalTok{(ynm))) }\OperatorTok{%>%}
\StringTok{    }\KeywordTok{group_by}\NormalTok{(}\OperatorTok{!!}\NormalTok{rlang}\OperatorTok{::}\KeywordTok{sym}\NormalTok{(blocks)) }\OperatorTok{%>%}
\StringTok{    }\KeywordTok{mutate}\NormalTok{(}
      \DataTypeTok{pib =} \KeywordTok{mean}\NormalTok{(soldvsnot17),}
      \DataTypeTok{nbwt =}\NormalTok{ (soldvsnot17 }\OperatorTok{/}\StringTok{ }\NormalTok{pib) }\OperatorTok{+}\StringTok{ }\NormalTok{((}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{soldvsnot17) }\OperatorTok{/}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{pib)),}
      \DataTypeTok{hbwt =}\NormalTok{ nbwt }\OperatorTok{*}\StringTok{ }\NormalTok{(pib }\OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{pib))}
\NormalTok{    )}
  \CommentTok{## Some blocks have no treated or no controls after dumping missing data}
\NormalTok{  dat <-}\StringTok{ }\NormalTok{dat }\OperatorTok{%>%}\StringTok{ }\KeywordTok{filter}\NormalTok{(pib }\OperatorTok{!=}\StringTok{ }\DecValTok{0} \OperatorTok{&}\StringTok{ }\NormalTok{pib }\OperatorTok{!=}\StringTok{ }\DecValTok{1}\NormalTok{)}
  \ControlFlowTok{if}\NormalTok{ (}\OperatorTok{!}\KeywordTok{is.null}\NormalTok{(covnms)) \{}
\NormalTok{    covdat <-}\StringTok{ }\KeywordTok{center_covs}\NormalTok{(dat, covnms, blocks)}
\NormalTok{    dat <-}\StringTok{ }\NormalTok{dplyr}\OperatorTok{::}\KeywordTok{select}\NormalTok{(dat, }\OperatorTok{-}\NormalTok{covnms)}
\NormalTok{    dat <-}\StringTok{ }\KeywordTok{bind_cols}\NormalTok{(dat, covdat)}
\NormalTok{    covnms <-}\StringTok{ }\KeywordTok{names}\NormalTok{(covdat)[}\KeywordTok{names}\NormalTok{(covdat) }\OperatorTok{!=}\StringTok{ }\NormalTok{blocks]}
\NormalTok{  \}}
\NormalTok{  rhs <-}\StringTok{ }\KeywordTok{unique}\NormalTok{(}\KeywordTok{c}\NormalTok{(}\StringTok{"soldvsnot17"}\NormalTok{, covnms))}
\NormalTok{  fmla <-}\StringTok{ }\KeywordTok{reformulate}\NormalTok{(rhs, }\DataTypeTok{response =}\NormalTok{ ynm)}
  \CommentTok{##  Adjust for differential cluster size (middleton and aronow)}
\NormalTok{  dat <-}\StringTok{ }\NormalTok{dat }\OperatorTok{%>%}
\StringTok{    }\KeywordTok{group_by}\NormalTok{(}\OperatorTok{!!}\NormalTok{rlang}\OperatorTok{::}\KeywordTok{sym}\NormalTok{(clusters)) }\OperatorTok{%>%}
\StringTok{    }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{nclus =} \KeywordTok{n}\NormalTok{())}
\NormalTok{  fmla <-}\StringTok{ }\KeywordTok{update}\NormalTok{(fmla, . }\OperatorTok{~}\StringTok{ }\NormalTok{. }\OperatorTok{+}\StringTok{ }\NormalTok{nclus)}
  \ControlFlowTok{if}\NormalTok{ (}\OperatorTok{!}\KeywordTok{is.null}\NormalTok{(weights)) \{}
\NormalTok{    obj <-}\StringTok{ }\KeywordTok{lm_robust}\NormalTok{(fmla,}
      \DataTypeTok{clusters =} \OperatorTok{!!}\NormalTok{rlang}\OperatorTok{::}\KeywordTok{sym}\NormalTok{(clusters), }\DataTypeTok{data =}\NormalTok{ dat,}
      \DataTypeTok{weights =} \OperatorTok{!!}\NormalTok{rlang}\OperatorTok{::}\KeywordTok{sym}\NormalTok{(weights), ...}
\NormalTok{    )}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    obj <-}\StringTok{ }\KeywordTok{lm_robust}\NormalTok{(fmla, }\DataTypeTok{clusters =} \OperatorTok{!!}\NormalTok{rlang}\OperatorTok{::}\KeywordTok{sym}\NormalTok{(clusters), }\DataTypeTok{data =}\NormalTok{ dat, ...)}
\NormalTok{  \}}
\NormalTok{  res <-}\StringTok{ }\KeywordTok{tidy}\NormalTok{(obj) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{filter}\NormalTok{(term }\OperatorTok{==}\StringTok{ "soldvsnot17"}\NormalTok{)}
  \KeywordTok{return}\NormalTok{(res)}
\NormalTok{\}}

\CommentTok{## Test the function.}
\KeywordTok{est1fn}\NormalTok{(}\StringTok{"dt_impact_i"}\NormalTok{, }\DataTypeTok{dat =}\NormalTok{ outdat5, }\DataTypeTok{blocks =} \StringTok{"fm2"}\NormalTok{, }\DataTypeTok{clusters =} \StringTok{"Q56"}\NormalTok{, }\DataTypeTok{weights =} \StringTok{"nbwt"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Warning: Assigning non-quosure objects to quosure lists is deprecated as of rlang 0.3.0.
Please coerce to a bare list beforehand with `as.list()`
This warning is displayed once per session.
\end{verbatim}

\begin{verbatim}
         term estimate std.error statistic p.value conf.low conf.high    df     outcome
1 soldvsnot17 0.001641   0.08518   0.01927  0.9849  -0.1835    0.1868 12.24 dt_impact_i
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{est1fn}\NormalTok{(}\StringTok{"dt_impact_i"}\NormalTok{, }\DataTypeTok{covnms =}\NormalTok{ regcovs, }\DataTypeTok{blocks =} \StringTok{"fm2"}\NormalTok{, }\DataTypeTok{dat =}\NormalTok{ outdat5, }\DataTypeTok{clusters =} \StringTok{"Q56"}\NormalTok{, }\DataTypeTok{weights =} \StringTok{"nbwt"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
         term estimate std.error statistic p.value conf.low conf.high   df     outcome
1 soldvsnot17    -0.02   0.09138   -0.2189  0.8302  -0.2179    0.1779 12.7 dt_impact_i
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{## Next two are precision weights.}
\KeywordTok{est1fn}\NormalTok{(}\StringTok{"dt_impact_i"}\NormalTok{, }\DataTypeTok{dat =}\NormalTok{ outdat5, }\DataTypeTok{blocks =} \StringTok{"fm2"}\NormalTok{, }\DataTypeTok{clusters =} \StringTok{"Q56"}\NormalTok{, }\DataTypeTok{weights =} \StringTok{"hbwt"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
         term estimate std.error statistic p.value conf.low conf.high    df     outcome
1 soldvsnot17 -0.01826    0.0775   -0.2356  0.8158  -0.1783    0.1418 23.71 dt_impact_i
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{est1fn}\NormalTok{(}\StringTok{"dt_impact_i"}\NormalTok{, }\DataTypeTok{dat =}\NormalTok{ outdat5, }\DataTypeTok{blocks =} \StringTok{"fm2"}\NormalTok{, }\DataTypeTok{clusters =} \StringTok{"Q56"}\NormalTok{, }\DataTypeTok{fixed_effects =} \OperatorTok{~}\NormalTok{fm2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
         term estimate std.error statistic p.value conf.low conf.high   df     outcome
1 soldvsnot17 -0.03241   0.08801   -0.3682  0.7177  -0.2195    0.1546 15.5 dt_impact_i
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{est1fn}\NormalTok{(}\StringTok{"dt_impact_i"}\NormalTok{, }\DataTypeTok{covnms =}\NormalTok{ regcovs, }\DataTypeTok{dat =}\NormalTok{ outdat5, }\DataTypeTok{blocks =} \StringTok{"fm2"}\NormalTok{, }\DataTypeTok{clusters =} \StringTok{"Q56"}\NormalTok{, }\DataTypeTok{weights =} \StringTok{"hbwt"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
         term estimate std.error statistic p.value conf.low conf.high    df     outcome
1 soldvsnot17 -0.04159   0.07713   -0.5393  0.5947  -0.2009    0.1177 23.66 dt_impact_i
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{est1fn}\NormalTok{(}\StringTok{"dt_impact_i"}\NormalTok{, }\DataTypeTok{covnms =}\NormalTok{ regcovs, }\DataTypeTok{dat =}\NormalTok{ outdat5, }\DataTypeTok{blocks =} \StringTok{"fm2"}\NormalTok{, }\DataTypeTok{clusters =} \StringTok{"Q56"}\NormalTok{, }\DataTypeTok{fixed_effects =} \OperatorTok{~}\NormalTok{fm2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
         term estimate std.error statistic p.value conf.low conf.high    df     outcome
1 soldvsnot17 -0.04821   0.08641   -0.5579  0.5847  -0.2316    0.1352 15.78 dt_impact_i
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{## Compare to the following test}
\NormalTok{test1 <-}\StringTok{ }\KeywordTok{balanceTest}\NormalTok{(soldvsnot17 }\OperatorTok{~}\StringTok{ }\NormalTok{dt_impact_i }\OperatorTok{+}\StringTok{ }\KeywordTok{strata}\NormalTok{(fm2) }\OperatorTok{+}\StringTok{ }\KeywordTok{cluster}\NormalTok{(Q56), }\DataTypeTok{data =}\NormalTok{ outdat5, }\DataTypeTok{report =} \StringTok{"all"}\NormalTok{)}
\NormalTok{test1}\OperatorTok{$}\NormalTok{results[, , }\StringTok{"fm2"}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
  Control Treatment  std.diff  adj.diff pooled.sd         z         p 
  2.06667   2.02439  -0.05505  -0.04228   0.76792   0.75302   0.45144 
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{test1rank <-}\StringTok{ }\KeywordTok{balanceTest}\NormalTok{(soldvsnot17 }\OperatorTok{~}\StringTok{ }\NormalTok{dt_impact_i }\OperatorTok{+}\StringTok{ }\KeywordTok{strata}\NormalTok{(fm2) }\OperatorTok{+}\StringTok{ }\KeywordTok{cluster}\NormalTok{(Q56), }\DataTypeTok{data =}\NormalTok{ outdat5, }\DataTypeTok{report =} \StringTok{"all"}\NormalTok{, }\DataTypeTok{post.alignment.transform =}\NormalTok{ rank)}
\NormalTok{test1rank}\OperatorTok{$}\NormalTok{results[, , }\StringTok{"fm2"}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
  Control Treatment  std.diff  adj.diff pooled.sd         z         p 
  2.06667   2.02439  -0.05505  -0.04228   0.76792   0.70416   0.48133 
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{## Getting missingness warnings}
\KeywordTok{est1fn}\NormalTok{(}\StringTok{"boca1_i"}\NormalTok{, }\DataTypeTok{dat =}\NormalTok{ outdat5, }\DataTypeTok{blocks =} \StringTok{"fm2"}\NormalTok{, }\DataTypeTok{clusters =} \StringTok{"Q56"}\NormalTok{, }\DataTypeTok{weights =} \StringTok{"nbwt"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
         term estimate std.error statistic p.value conf.low conf.high    df outcome
1 soldvsnot17 -0.04675    0.1118    -0.418  0.6827  -0.2881    0.1946 13.12 boca1_i
\end{verbatim}

\normalsize

Do the basic analyses. For now, and for speed, only using block-size
weights. Obviously, more power is available with precision weights.
Prefer the confidence intervals and \(p\)-value from the precision
weights.

\scriptsize

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# options(warn=1)}
\NormalTok{res1 <-}\StringTok{ }\KeywordTok{lapply}\NormalTok{(regoutcomes, }\ControlFlowTok{function}\NormalTok{(ynm) \{}
  \KeywordTok{message}\NormalTok{(ynm)}
\NormalTok{  unadj <-}\StringTok{ }\KeywordTok{est1fn}\NormalTok{(ynm, }\DataTypeTok{dat =}\NormalTok{ outdat5, }\DataTypeTok{blocks =} \StringTok{"fm2"}\NormalTok{, }\DataTypeTok{clusters =} \StringTok{"Q56"}\NormalTok{, }\DataTypeTok{weights =} \StringTok{"nbwt"}\NormalTok{)}
\NormalTok{  covadj <-}\StringTok{ }\KeywordTok{est1fn}\NormalTok{(ynm, }\DataTypeTok{covnms =}\NormalTok{ regcovs, }\DataTypeTok{blocks =} \StringTok{"fm2"}\NormalTok{, }\DataTypeTok{dat =}\NormalTok{ outdat5, }\DataTypeTok{clusters =} \StringTok{"Q56"}\NormalTok{, }\DataTypeTok{weights =} \StringTok{"nbwt"}\NormalTok{)}
\NormalTok{  tmp <-}\StringTok{ }\KeywordTok{bind_cols}\NormalTok{(unadj, covadj)}
\NormalTok{\})}

\NormalTok{resdt <-}\StringTok{ }\KeywordTok{bind_rows}\NormalTok{(res1)}

\NormalTok{resdt}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
         term  estimate std.error statistic p.value  conf.low conf.high    df          outcome       term1 estimate1 std.error1
1 soldvsnot17 -0.233730   0.15741  -1.48484 0.15960 -0.571127   0.10367 14.10          n_sec_i soldvsnot17  -0.24828    0.15729
2 soldvsnot17 -0.062214   0.09295  -0.66935 0.51432 -0.261851   0.13742 13.79          c_sec_i soldvsnot17  -0.07339    0.09214
3 soldvsnot17  0.059182   0.03049   1.94131 0.07248 -0.006161   0.12453 14.10          vic12_i soldvsnot17   0.06920    0.03059
4 soldvsnot17  0.001641   0.08518   0.01927 0.98494 -0.183544   0.18683 12.24      dt_impact_i soldvsnot17  -0.02000    0.09138
5 soldvsnot17 -0.038973   0.07532  -0.51740 0.61162 -0.198032   0.12009 16.81      ps_impact_i soldvsnot17  -0.04152    0.07173
6 soldvsnot17 -0.046747   0.11183  -0.41803 0.68269 -0.288108   0.19461 13.12          boca1_i soldvsnot17  -0.03124    0.10964
7 soldvsnot17 -0.108914   0.07091  -1.53604 0.14667 -0.260895   0.04307 14.10       social_dis soldvsnot17  -0.10364    0.07467
8 soldvsnot17  0.020556   0.02897   0.70969 0.48989 -0.041742   0.08285 13.60 activities_index soldvsnot17   0.02609    0.02834
  statistic1 p.value1 conf.low1 conf.high1   df1         outcome1
1    -1.5785  0.13595 -0.584444    0.08788 14.55          n_sec_i
2    -0.7965  0.43880 -0.270644    0.12387 14.28          c_sec_i
3     2.2620  0.03948  0.003819    0.13459 14.55          vic12_i
4    -0.2189  0.83021 -0.217896    0.17789 12.70      dt_impact_i
5    -0.5789  0.57038 -0.193015    0.10997 16.77      ps_impact_i
6    -0.2849  0.77997 -0.266781    0.20431 13.76          boca1_i
7    -1.3880  0.18603 -0.263229    0.05594 14.55       social_dis
8     0.9205  0.37298 -0.034728    0.08690 13.92 activities_index
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{kable}\NormalTok{(resdt)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lrrrrrrrllrrrrrrrl@{}}
\toprule
term & estimate & std.error & statistic & p.value & conf.low & conf.high
& df & outcome & term1 & estimate1 & std.error1 & statistic1 & p.value1
& conf.low1 & conf.high1 & df1 & outcome1\tabularnewline
\midrule
\endhead
soldvsnot17 & -0.2337 & 0.1574 & -1.4848 & 0.1596 & -0.5711 & 0.1037 &
14.10 & n\_sec\_i & soldvsnot17 & -0.2483 & 0.1573 & -1.5785 & 0.1359 &
-0.5844 & 0.0879 & 14.55 & n\_sec\_i\tabularnewline
soldvsnot17 & -0.0622 & 0.0929 & -0.6694 & 0.5143 & -0.2619 & 0.1374 &
13.79 & c\_sec\_i & soldvsnot17 & -0.0734 & 0.0921 & -0.7965 & 0.4388 &
-0.2706 & 0.1239 & 14.28 & c\_sec\_i\tabularnewline
soldvsnot17 & 0.0592 & 0.0305 & 1.9413 & 0.0725 & -0.0062 & 0.1245 &
14.10 & vic12\_i & soldvsnot17 & 0.0692 & 0.0306 & 2.2620 & 0.0395 &
0.0038 & 0.1346 & 14.55 & vic12\_i\tabularnewline
soldvsnot17 & 0.0016 & 0.0852 & 0.0193 & 0.9849 & -0.1835 & 0.1868 &
12.24 & dt\_impact\_i & soldvsnot17 & -0.0200 & 0.0914 & -0.2189 &
0.8302 & -0.2179 & 0.1779 & 12.70 & dt\_impact\_i\tabularnewline
soldvsnot17 & -0.0390 & 0.0753 & -0.5174 & 0.6116 & -0.1980 & 0.1201 &
16.81 & ps\_impact\_i & soldvsnot17 & -0.0415 & 0.0717 & -0.5789 &
0.5704 & -0.1930 & 0.1100 & 16.77 & ps\_impact\_i\tabularnewline
soldvsnot17 & -0.0467 & 0.1118 & -0.4180 & 0.6827 & -0.2881 & 0.1946 &
13.12 & boca1\_i & soldvsnot17 & -0.0312 & 0.1096 & -0.2849 & 0.7800 &
-0.2668 & 0.2043 & 13.76 & boca1\_i\tabularnewline
soldvsnot17 & -0.1089 & 0.0709 & -1.5360 & 0.1467 & -0.2609 & 0.0431 &
14.10 & social\_dis & soldvsnot17 & -0.1036 & 0.0747 & -1.3880 & 0.1860
& -0.2632 & 0.0559 & 14.55 & social\_dis\tabularnewline
soldvsnot17 & 0.0206 & 0.0290 & 0.7097 & 0.4899 & -0.0417 & 0.0829 &
13.60 & activities\_index & soldvsnot17 & 0.0261 & 0.0283 & 0.9205 &
0.3730 & -0.0347 & 0.0869 & 13.92 & activities\_index\tabularnewline
\bottomrule
\end{longtable}

\normalsize

\hypertarget{compare-to-rank-based-tests}{%
\subsection{Compare to rank based
tests}\label{compare-to-rank-based-tests}}

\hypertarget{check-performance-of-the-estimator-and-tests}{%
\subsection{Check performance of the estimator and
tests}\label{check-performance-of-the-estimator-and-tests}}

\hypertarget{do-direct-permutation-based-tests}{%
\subsection{Do direct permutation based
tests}\label{do-direct-permutation-based-tests}}

\hypertarget{does-treatment-assignment-relate-to-missingness}{%
\subsection{Does treatment assignment relate to
missingness?}\label{does-treatment-assignment-relate-to-missingness}}

\printbibliography


\end{document}
